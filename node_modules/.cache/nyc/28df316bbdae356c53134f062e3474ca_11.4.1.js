var cov_peugipqee=function(){var path='/home/bwilbur/projects/mercury/modules/agency/models/agency-dao.js',hash='0a73ce90a219a32b2c4b681176266100821f36e8',global=new Function('return this')(),gcv='__coverage__',coverageData={path:'/home/bwilbur/projects/mercury/modules/agency/models/agency-dao.js',statementMap:{'0':{start:{line:1,column:17},end:{line:1,column:36}},'1':{start:{line:2,column:15},end:{line:2,column:34}},'2':{start:{line:3,column:19},end:{line:3,column:60}},'3':{start:{line:4,column:16},end:{line:4,column:55}},'4':{start:{line:18,column:21},end:{line:18,column:37}},'5':{start:{line:19,column:18},end:{line:32,column:4}},'6':{start:{line:20,column:3},end:{line:31,column:6}},'7':{start:{line:21,column:4},end:{line:28,column:5}},'8':{start:{line:23,column:5},end:{line:23,column:45}},'9':{start:{line:27,column:5},end:{line:27,column:29}},'10':{start:{line:30,column:4},end:{line:30,column:18}},'11':{start:{line:33,column:2},end:{line:33,column:17}},'12':{start:{line:43,column:18},end:{line:43,column:31}},'13':{start:{line:44,column:18},end:{line:79,column:4}},'14':{start:{line:45,column:3},end:{line:48,column:4}},'15':{start:{line:47,column:4},end:{line:47,column:14}},'16':{start:{line:50,column:26},end:{line:50,column:40}},'17':{start:{line:51,column:26},end:{line:53,column:5}},'18':{start:{line:52,column:4},end:{line:52,column:33}},'19':{start:{line:55,column:23},end:{line:76,column:5}},'20':{start:{line:56,column:24},end:{line:56,column:40}},'21':{start:{line:57,column:24},end:{line:57,column:31}},'22':{start:{line:58,column:21},end:{line:58,column:35}},'23':{start:{line:60,column:4},end:{line:73,column:5}},'24':{start:{line:62,column:23},end:{line:62,column:37}},'25':{start:{line:63,column:5},end:{line:72,column:6}},'26':{start:{line:65,column:24},end:{line:65,column:38}},'27':{start:{line:66,column:6},end:{line:71,column:7}},'28':{start:{line:68,column:20},end:{line:68,column:29}},'29':{start:{line:69,column:7},end:{line:69,column:36}},'30':{start:{line:70,column:7},end:{line:70,column:40}},'31':{start:{line:75,column:4},end:{line:75,column:22}},'32':{start:{line:78,column:3},end:{line:78,column:22}},'33':{start:{line:81,column:2},end:{line:81,column:17}},'34':{start:{line:90,column:21},end:{line:90,column:37}},'35':{start:{line:91,column:25},end:{line:91,column:78}},'36':{start:{line:92,column:25},end:{line:94,column:4}},'37':{start:{line:93,column:3},end:{line:93,column:32}},'38':{start:{line:96,column:22},end:{line:119,column:4}},'39':{start:{line:97,column:23},end:{line:97,column:39}},'40':{start:{line:98,column:23},end:{line:98,column:30}},'41':{start:{line:100,column:20},end:{line:100,column:34}},'42':{start:{line:101,column:3},end:{line:116,column:4}},'43':{start:{line:103,column:22},end:{line:103,column:36}},'44':{start:{line:104,column:17},end:{line:104,column:26}},'45':{start:{line:105,column:4},end:{line:113,column:5}},'46':{start:{line:107,column:23},end:{line:107,column:37}},'47':{start:{line:108,column:5},end:{line:112,column:6}},'48':{start:{line:110,column:6},end:{line:110,column:41}},'49':{start:{line:111,column:6},end:{line:111,column:12}},'50':{start:{line:115,column:4},end:{line:115,column:37}},'51':{start:{line:118,column:3},end:{line:118,column:21}},'52':{start:{line:121,column:2},end:{line:121,column:21}},'53':{start:{line:132,column:23},end:{line:132,column:54}},'54':{start:{line:133,column:17},end:{line:133,column:79}},'55':{start:{line:134,column:18},end:{line:134,column:95}},'56':{start:{line:135,column:2},end:{line:135,column:17}},'57':{start:{line:146,column:23},end:{line:146,column:54}},'58':{start:{line:147,column:17},end:{line:147,column:75}},'59':{start:{line:148,column:18},end:{line:148,column:95}},'60':{start:{line:149,column:2},end:{line:149,column:17}},'61':{start:{line:153,column:0},end:{line:153,column:27}}},fnMap:{'0':{name:'(anonymous_0)',decl:{start:{line:16,column:1},end:{line:16,column:2}},loc:{start:{line:17,column:1},end:{line:34,column:2}},line:17},'1':{name:'(anonymous_1)',decl:{start:{line:19,column:58},end:{line:19,column:59}},loc:{start:{line:19,column:68},end:{line:32,column:3}},line:19},'2':{name:'(anonymous_2)',decl:{start:{line:20,column:85},end:{line:20,column:86}},loc:{start:{line:20,column:102},end:{line:31,column:4}},line:20},'3':{name:'(anonymous_3)',decl:{start:{line:41,column:1},end:{line:41,column:2}},loc:{start:{line:42,column:1},end:{line:82,column:2}},line:42},'4':{name:'(anonymous_4)',decl:{start:{line:44,column:52},end:{line:44,column:53}},loc:{start:{line:44,column:60},end:{line:79,column:3}},line:44},'5':{name:'(anonymous_5)',decl:{start:{line:51,column:85},end:{line:51,column:86}},loc:{start:{line:51,column:104},end:{line:53,column:4}},line:51},'6':{name:'(anonymous_6)',decl:{start:{line:55,column:74},end:{line:55,column:75}},loc:{start:{line:55,column:82},end:{line:76,column:4}},line:55},'7':{name:'(anonymous_7)',decl:{start:{line:88,column:1},end:{line:88,column:2}},loc:{start:{line:89,column:1},end:{line:122,column:2}},line:89},'8':{name:'(anonymous_8)',decl:{start:{line:92,column:70},end:{line:92,column:71}},loc:{start:{line:92,column:89},end:{line:94,column:3}},line:92},'9':{name:'(anonymous_9)',decl:{start:{line:96,column:73},end:{line:96,column:74}},loc:{start:{line:96,column:81},end:{line:119,column:3}},line:96},'10':{name:'(anonymous_10)',decl:{start:{line:130,column:1},end:{line:130,column:2}},loc:{start:{line:131,column:1},end:{line:136,column:2}},line:131},'11':{name:'(anonymous_11)',decl:{start:{line:144,column:1},end:{line:144,column:2}},loc:{start:{line:145,column:1},end:{line:150,column:2}},line:145}},branchMap:{'0':{loc:{start:{line:21,column:4},end:{line:28,column:5}},type:'if',locations:[{start:{line:21,column:4},end:{line:28,column:5}},{start:{line:21,column:4},end:{line:28,column:5}}],line:21},'1':{loc:{start:{line:45,column:3},end:{line:48,column:4}},type:'if',locations:[{start:{line:45,column:3},end:{line:48,column:4}},{start:{line:45,column:3},end:{line:48,column:4}}],line:45},'2':{loc:{start:{line:52,column:11},end:{line:52,column:32}},type:'binary-expr',locations:[{start:{line:52,column:11},end:{line:52,column:26}},{start:{line:52,column:30},end:{line:52,column:32}}],line:52},'3':{loc:{start:{line:66,column:6},end:{line:71,column:7}},type:'if',locations:[{start:{line:66,column:6},end:{line:71,column:7}},{start:{line:66,column:6},end:{line:71,column:7}}],line:66},'4':{loc:{start:{line:93,column:10},end:{line:93,column:31}},type:'binary-expr',locations:[{start:{line:93,column:10},end:{line:93,column:25}},{start:{line:93,column:29},end:{line:93,column:31}}],line:93},'5':{loc:{start:{line:108,column:5},end:{line:112,column:6}},type:'if',locations:[{start:{line:108,column:5},end:{line:112,column:6}},{start:{line:108,column:5},end:{line:112,column:6}}],line:108},'6':{loc:{start:{line:110,column:20},end:{line:110,column:40}},type:'binary-expr',locations:[{start:{line:110,column:20},end:{line:110,column:34}},{start:{line:110,column:38},end:{line:110,column:40}}],line:110}},s:{'0':0,'1':0,'2':0,'3':0,'4':0,'5':0,'6':0,'7':0,'8':0,'9':0,'10':0,'11':0,'12':0,'13':0,'14':0,'15':0,'16':0,'17':0,'18':0,'19':0,'20':0,'21':0,'22':0,'23':0,'24':0,'25':0,'26':0,'27':0,'28':0,'29':0,'30':0,'31':0,'32':0,'33':0,'34':0,'35':0,'36':0,'37':0,'38':0,'39':0,'40':0,'41':0,'42':0,'43':0,'44':0,'45':0,'46':0,'47':0,'48':0,'49':0,'50':0,'51':0,'52':0,'53':0,'54':0,'55':0,'56':0,'57':0,'58':0,'59':0,'60':0,'61':0},f:{'0':0,'1':0,'2':0,'3':0,'4':0,'5':0,'6':0,'7':0,'8':0,'9':0,'10':0,'11':0},b:{'0':[0,0],'1':[0,0],'2':[0,0],'3':[0,0],'4':[0,0],'5':[0,0],'6':[0,0]},_coverageSchema:'332fd63041d2c1bcb487cc26dd0d5f7d97098a6c'},coverage=global[gcv]||(global[gcv]={});if(coverage[path]&&coverage[path].hash===hash){return coverage[path];}coverageData.hash=hash;return coverage[path]=coverageData;}();const mongoose=(cov_peugipqee.s[0]++,require('mongoose'));const Agency=(cov_peugipqee.s[1]++,require('./agency'));const ApiService=(cov_peugipqee.s[2]++,require('./../../api/models/api-service'));const UserDao=(cov_peugipqee.s[3]++,require('./../../user/models/user-dao'));/**
 * Database access associated with agencies
 */class AgencyDao{/**
	 * Loads a single building with the given ID
	 * @param string id
	 * @return Promise
	 */loadOne(id){cov_peugipqee.f[0]++;const apiService=(cov_peugipqee.s[4]++,new ApiService());const promise=(cov_peugipqee.s[5]++,apiService.apiGet('/agency/'+id).then(agency=>{cov_peugipqee.f[1]++;cov_peugipqee.s[6]++;return Agency.findOne({sequoiaId:agency.agency.id}).populate('reps').exec().then(mercuryAgency=>{cov_peugipqee.f[2]++;cov_peugipqee.s[7]++;if(mercuryAgency){cov_peugipqee.b[0][0]++;cov_peugipqee.s[8]++;agency.agency.reps=mercuryAgency.reps;}else{cov_peugipqee.b[0][1]++;cov_peugipqee.s[9]++;agency.agency.reps=[];}cov_peugipqee.s[10]++;return agency;});}));cov_peugipqee.s[11]++;return promise;}/**
	 * Returns a list of all agencies to which the requesting user is assigned
	 * @param string agencyRepId
	 * @return Promise
	 */loadForLoggedInUser(req){cov_peugipqee.f[3]++;const userDao=(cov_peugipqee.s[12]++,new UserDao());const promise=(cov_peugipqee.s[13]++,userDao.loadFromRequest(req).then(user=>{cov_peugipqee.f[4]++;cov_peugipqee.s[14]++;if(!user){cov_peugipqee.b[1][0]++;cov_peugipqee.s[15]++;return[];}else{cov_peugipqee.b[1][1]++;}const sequoiaPromise=(cov_peugipqee.s[16]++,this.loadAll());const mercuryPromise=(cov_peugipqee.s[17]++,Agency.find({reps:user._id}).populate('reps').exec().then(mercuryAgencies=>{cov_peugipqee.f[5]++;cov_peugipqee.s[18]++;return(cov_peugipqee.b[2][0]++,mercuryAgencies)||(cov_peugipqee.b[2][1]++,[]);}));const joinPromise=(cov_peugipqee.s[19]++,Promise.all([sequoiaPromise,mercuryPromise]).then(data=>{cov_peugipqee.f[6]++;const seqAgencies=(cov_peugipqee.s[20]++,data[0].agencies);const merAgencies=(cov_peugipqee.s[21]++,data[1]);let agencyData=(cov_peugipqee.s[22]++,{agencies:[]});cov_peugipqee.s[23]++;for(let i=0;i<merAgencies.length;i++){const merAgency=(cov_peugipqee.s[24]++,merAgencies[i]);cov_peugipqee.s[25]++;for(let j=0;j<seqAgencies.length;j++){const seqAgency=(cov_peugipqee.s[26]++,seqAgencies[j]);cov_peugipqee.s[27]++;if(merAgency.sequoiaId.toString()==seqAgency.id.toString()){cov_peugipqee.b[3][0]++;let agency=(cov_peugipqee.s[28]++,seqAgency);cov_peugipqee.s[29]++;agency.reps=merAgency.reps;cov_peugipqee.s[30]++;agencyData.agencies.push(agency);}else{cov_peugipqee.b[3][1]++;}}}cov_peugipqee.s[31]++;return agencyData;}));cov_peugipqee.s[32]++;return joinPromise;}));cov_peugipqee.s[33]++;return promise;}/**
	 * Returns a list of all agencies
	 * @return Promise
	 */loadAll(){cov_peugipqee.f[7]++;const apiService=(cov_peugipqee.s[34]++,new ApiService());const sequoiaPromise=(cov_peugipqee.s[35]++,apiService.apiGet('/agency/all',{include:'legacy'}));const mercuryPromise=(cov_peugipqee.s[36]++,Agency.find({}).populate('reps').exec().then(mercuryAgencies=>{cov_peugipqee.f[8]++;cov_peugipqee.s[37]++;return(cov_peugipqee.b[4][0]++,mercuryAgencies)||(cov_peugipqee.b[4][1]++,[]);}));const joinPromise=(cov_peugipqee.s[38]++,Promise.all([sequoiaPromise,mercuryPromise]).then(data=>{cov_peugipqee.f[9]++;const seqAgencies=(cov_peugipqee.s[39]++,data[0].agencies);const merAgencies=(cov_peugipqee.s[40]++,data[1]);let agencyData=(cov_peugipqee.s[41]++,{agencies:[]});cov_peugipqee.s[42]++;for(let i=0;i<seqAgencies.length;i++){const seqAgency=(cov_peugipqee.s[43]++,seqAgencies[i]);let agency=(cov_peugipqee.s[44]++,seqAgency);cov_peugipqee.s[45]++;for(let j=0;j<merAgencies.length;j++){const merAgency=(cov_peugipqee.s[46]++,merAgencies[j]);cov_peugipqee.s[47]++;if(merAgency.sequoiaId.toString()==seqAgency.id.toString()){cov_peugipqee.b[5][0]++;cov_peugipqee.s[48]++;agency.reps=(cov_peugipqee.b[6][0]++,merAgency.reps)||(cov_peugipqee.b[6][1]++,[]);cov_peugipqee.s[49]++;break;}else{cov_peugipqee.b[5][1]++;}}cov_peugipqee.s[50]++;agencyData.agencies.push(agency);}cov_peugipqee.s[51]++;return agencyData;}));cov_peugipqee.s[52]++;return joinPromise;}/**
	 * Assigns a rep to the given agency
	 * @param string agencyId
	 * @param string userId
	 * @return Promise
	 */assignRep(agencyId,userId){cov_peugipqee.f[10]++;const userObjectId=(cov_peugipqee.s[53]++,mongoose.Types.ObjectId(userId));const update=(cov_peugipqee.s[54]++,{$set:{sequoiaId:agencyId},$addToSet:{reps:userObjectId}});const promise=(cov_peugipqee.s[55]++,Agency.findOneAndUpdate({sequoiaId:agencyId},update,{upsert:true}).exec());cov_peugipqee.s[56]++;return promise;}/**
	 * Removes a rep from the given agency
	 * @param string agencyId
	 * @param string userId
	 * @return Promise
	 */unassignRep(agencyId,userId){cov_peugipqee.f[11]++;const userObjectId=(cov_peugipqee.s[57]++,mongoose.Types.ObjectId(userId));const update=(cov_peugipqee.s[58]++,{$set:{sequoiaId:agencyId},$pull:{reps:userObjectId}});const promise=(cov_peugipqee.s[59]++,Agency.findOneAndUpdate({sequoiaId:agencyId},update,{upsert:true}).exec());cov_peugipqee.s[60]++;return promise;}}cov_peugipqee.s[61]++;module.exports=AgencyDao;